import React, { useEffect, useMemo, useState, memo } from "react";

// === Assets ===
const ASSETS = {
  backgroundVideo: "https://raw.githubusercontent.com/SnchzBroz/SnchzBroz/main/Nuevo%20Azul.mp4",
  logo: "https://raw.githubusercontent.com/SnchzBroz/SnchzBroz/main/Nuevo%20Logo.png",
  poster: "https://raw.githubusercontent.com/SnchzBroz/SnchzBroz/main/Nuevo%20Logo.png",
};

// === Widgets ===
const WIDGETS = {
  likeFountain: "https://tikfinity.zerody.one/widget/likefountain?cid=615689",
  actions: "https://tikfinity.zerody.one/widget/myactions?cid=615689&screen=1",
  lastFollower: "https://tikfinity.zerody.one/widget/lastx?cid=615689&x=follower",
  lastGifter: "https://tikfinity.zerody.one/widget/lastx?cid=615689&x=gifter",
  lastSubscriber: "https://tikfinity.zerody.one/widget/lastx?cid=615689&x=subscriber",
};

// === Mensajes rotativos para tarjetas superiores ===
const FOLLOWER_MESSAGES = [
  "Â¡El nuevo Bro! ğŸ¤©",
  "Â¡Nuevo Bro en la casa! ğŸ‰",
  "Â¡Gracias por unirte al desmadre! ğŸ™Œ",
  "Â¡Bienvenid@ al team, Bro! ğŸ˜",
  "Â¡Un Bro mÃ¡s en el canal! ğŸ¥³",
  "Â¡Ahora somos mÃ¡s Bros! ğŸ”¥",
  "Â¡Nuevo Bro! Â¡QuÃ© locura! ğŸ¤¯",
  "Â¡Un Bro mÃ¡s a la cuenta! âœ…",
  "Â¡Ahora eres un Bro de Ã©lite! ğŸ˜",
  "Â¡Un nuevo Bro ha aparecido! ğŸ‘¾",
  "Â¡Ahora si somos mÃ¡s fuertes! ğŸ’ª",
];

const GIFT_MESSAGES = [
  "Â¡Gracias por tu Oro! ğŸ",
  "Â¡Oro en la casa! Â¡Gracias por el apoyo! ğŸ™",
  "Â¡QuÃ© buen regalo, muchas gracias! ğŸ™",
  "Â¡Me has dejado sin palabras! Â¡Gracias! ğŸ’–",
  "Â¡Tu generosidad es increÃ­ble! Â¡Gracias! ğŸ’«",
  "Â¡Gracias por ese detallazo! ğŸ¤©",
  "Â¡Ese regalo me ha subido el stream de nivel! Â¡Gracias! ğŸš€",
  "Â¡EstÃ¡s echando la casa por la ventana! Â¡Gracias! ğŸ‰",
  "Â¿De dÃ³nde sacas tanto dinero? Â¡Gracias por el regalo, Bro! ğŸ’°",
  "Â¡OjalÃ¡ se me pegara un poco de tu generosidad! Â¡Gracias! ğŸ˜‚",
  "Â¡Gracias por ese regalo! Â¡Con esto nos compramos la cena! ğŸ”",
];

const SUB_MESSAGES = [
  "Â¡Bienvenido a la familia! ğŸ’–",
  "Â¡El team SnchzBroz crece! Â¡Bienvenido! ğŸ¥³",
  "Â¡Gracias por unirte a la familia! ğŸ¥°",
  "Â¡Un nuevo miembro en la SnchzBroz-familia! ğŸ’–",
  "Â¡Bienvenido al club! ğŸ˜",
  "Â¡Ahora eres parte de los Bros! Â¡Gracias! ğŸ‰",
  "Â¡Te has unido a los Bros de verdad! Â¡Bienvenido! ğŸ˜",
  "Â¡Bienvenido al club! Â¡Ahora no hay marcha atrÃ¡s! ğŸ˜œ",
  "Â¡Por fin has caÃ­do! Â¡Bienvenido a la familia SnchzBroz! ğŸ’–",
  "Â¡Gracias por tu sub! Â¡Ahora eres parte de la secta! ğŸ˜ˆ",
  "Â¡Te has ganado mi respeto! Â¡Bienvenido a la familia! ğŸ¥‚",
];

// === NeonFrame con variantes de color ===
const NeonFrame = memo(function NeonFrame({ children, className = "", variant = "default" }) {
  const gradients = {
    // Para redes sociales (verde/azul)
    default:
      "conic-gradient(from 0deg, rgba(0,255,128,.85), rgba(0,128,255,.85), rgba(0,255,128,.85))",
    // Para tarjetas superiores (morado/fucsia)
    topCards:
      "conic-gradient(from 0deg, rgba(255,0,255,.85), rgba(138,43,226,.85), rgba(255,0,255,.85))",
  };

  return (
    <div className={`relative rounded-xl overflow-hidden ${className}`} style={{ isolation: "isolate" }}>
      {/* Glow externo vistoso (recortado por overflow-hidden) */}
      <div
        aria-hidden
        className="absolute -inset-1 rounded-[inherit] blur-xl opacity-80 pointer-events-none"
        style={{ background: gradients[variant] || gradients.default, animation: "glowPulse 4.5s ease-in-out infinite" }}
      />
      {/* Contenido con UN solo borde sutil */}
      <div className="relative rounded-[inherit] bg-white/8 border border-white/10 shadow-lg flex items-center justify-center">
        {children}
      </div>
    </div>
  );
});

// === Datos de redes (icono + handle) ===
const SOCIALS = [
  { img: "https://cdn-icons-png.flaticon.com/128/3046/3046121.png", handle: "@snchzbroz" }, // TikTok
  { img: "https://cdn-icons-png.flaticon.com/128/174/174855.png", handle: "@snchzbroz" }, // Instagram
  { img: "https://cdn-icons-png.flaticon.com/128/5969/5969020.png", handle: "@twittalien" }, // X/Twitter
  { img: "https://cdn-icons-png.flaticon.com/128/1384/1384060.png", handle: "snchzbroz" }, // YouTube
  { img: "https://cdn-icons-png.flaticon.com/128/15713/15713413.png", handle: "snchzbroz" }, // Twitch
  { img: "https://cdn-icons-png.flaticon.com/128/906/906325.png", handle: "snchzbroz" }, // Xbox
  { img: "https://cdn-icons-png.flaticon.com/128/6646/6646449.png", handle: "snchzbroz" }, // Fortnite
  { img: "https://cdn-icons-png.flaticon.com/128/871/871377.png", handle: "snchzbroz" }, // Nintendo
  { img: "https://cdn-icons-png.flaticon.com/128/15069/15069134.png", handle: "snchzbroz" }, // Roblox
];

// === Item de carrusel (logo + texto Roboto grande) ===
const SocialItem = memo(function SocialItem({ item }) {
  return (
    <div className="min-w-[260px]">
      <NeonFrame>
        <div className="flex flex-row items-center justify-center gap-4 px-5 py-3 rounded-xl bg-white/10 border border-white/10 font-roboto">
          <img src={item.img} alt="icon" className="h-12 w-12 object-contain drop-shadow" loading="lazy" referrerPolicy="no-referrer" />
          <span className="text-white/95 text-3xl tracking-wide">{item.handle}</span>
        </div>
      </NeonFrame>
    </div>
  );
});

// === Carrusel continuo derecha â†’ izquierda ===
function SocialCarousel() {
  const items = [...SOCIALS, ...SOCIALS]; // duplicado para loop
  return (
    <div className="relative overflow-hidden w-full">
      <div className="flex gap-6 animate-marqueeXRtl will-change-transform">
        {items.map((s, i) => (
          <SocialItem item={s} key={`${s.handle}-${i}`} />
        ))}
      </div>
      <style>{`
        @keyframes marqueeXRtl { 0% { transform: translateX(0%); } 100% { transform: translateX(-50%); } }
        .animate-marqueeXRtl { animation: marqueeXRtl 30s linear infinite; }
        @keyframes glowPulse { 0%,100% { opacity:.45 } 50% { opacity:.9 } }
      `}</style>
    </div>
  );
}

// === Badge aleatorio con brillo y color por tarjeta ===
function RandomBadge({ messages, variant, position = "bottom-right" }) {
  const [text, setText] = useState("");
  useEffect(() => {
    const pick = () => messages[Math.floor(Math.random() * messages.length)];
    setText(pick());
    const id = setInterval(() => setText(pick()), 5 * 60 * 1000); // cada 5 minutos
    return () => clearInterval(id);
  }, [messages]);

  const gradientByVariant = {
    follower: "linear-gradient(90deg, #00ff80, #0080ff)",
    gift: "linear-gradient(90deg, #ffd700, #ff8c00)",
    sub: "linear-gradient(90deg, #ff00ff, #8a2be2)",
  };

  const posClass = position === "bottom-right" ? "bottom-1.5 right-2" : "top-1.5 left-2";

  return (
    <div className={`absolute ${posClass} z-10`}>
      <div
        className="relative px-3 py-1 rounded-lg text-white/95 text-[13px] md:text-sm font-semibold tracking-wide shadow"
        style={{ background: "rgba(0,0,0,0.55)" }}
      >
        {/* Borde con glow animado */}
        <span
          aria-hidden
          className="pointer-events-none absolute inset-0 rounded-[inherit]"
          style={{
            padding: 1,
            background: gradientByVariant[variant] || gradientByVariant.follower,
            WebkitMask: "linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0)",
            WebkitMaskComposite: "xor",
            maskComposite: "exclude",
            filter: "drop-shadow(0 0 10px rgba(255,255,255,0.25))",
            animation: "badgeGlow 2.8s ease-in-out infinite",
          }}
        />
        <span className="relative z-10 whitespace-nowrap">{text}</span>
      </div>
      <style>{`
        @keyframes badgeGlow { 0%,100% { opacity:.85 } 50% { opacity:1 } }
      `}</style>
    </div>
  );
}

// === Tarjeta superior con iframe + tÃ­tulo fijo (arriba izq con halo) + badge dinÃ¡mico (abajo der) ===
function TopCard({ src, title, messages, badgeVariant }) {
  return (
    <NeonFrame variant="topCards" className="p-2 relative">
      {/* Texto fijo arriba izquierda con halo/contorno para legibilidad */}
      <div
        className="absolute top-1.5 left-2 z-10 text-white/90 text-sm font-bold select-none"
        style={{ textShadow: "1px 1px 2px rgba(0,0,0,0.9), -1px -1px 2px rgba(0,0,0,0.9)" }}
      >
        {title}
      </div>
      {/* Texto dinÃ¡mico abajo derecha */}
      <RandomBadge messages={messages} variant={badgeVariant} position="bottom-right" />
      <iframe src={src} title={title} className="w-full" style={{ height: 96 }} frameBorder={0} loading="lazy" />
    </NeonFrame>
  );
}

// === App principal ===
export default function StreamBackdropApp() {
  const videoSupported = useMemo(() => typeof window !== "undefined", []);
  const [videoReady, setVideoReady] = useState(false);
  const [mountMainIframe, setMountMainIframe] = useState(false);
  const [mountTopIframes, setMountTopIframes] = useState(false);

  // Montaje diferido de iframes para acelerar la carga
  useEffect(() => {
    const t1 = setTimeout(() => setMountMainIframe(true), 300);
    const t2 = setTimeout(() => setMountTopIframes(true), 700);
    return () => { clearTimeout(t1); clearTimeout(t2); };
  }, []);

  return (
    <div className="relative w-screen h-screen overflow-hidden select-none">
      {/* Like Fountain encima de todo */}
      <div className="absolute top-0 left-0 w-full h-full pointer-events-none z-50">
        <iframe src={WIDGETS.likeFountain} title="Like Fountain" className="w-full h-full" frameBorder={0} allow="autoplay" />
      </div>

      {/* Video de fondo */}
      <div className="absolute inset-0 -z-10">
        {videoSupported ? (
          <video
            className={`h-full w-full object-cover transition-opacity duration-500 ${videoReady ? "opacity-100" : "opacity-0"}`}
            src={ASSETS.backgroundVideo}
            autoPlay
            muted
            loop
            playsInline
            onCanPlay={() => setVideoReady(true)}
            poster={ASSETS.poster}
            preload="metadata"
          />
        ) : (
          <div className="h-full w-full bg-gradient-to-br from-indigo-900 via-purple-900 to-slate-900" />
        )}
        <div className="absolute inset-0 bg-gradient-to-b from-black/30 via-black/10 to-black/60 pointer-events-none" />
      </div>

      {/* Tarjetas superiores (morado/fucsia) */}
      <div className="absolute top-6 left-6 right-6 grid grid-cols-3 gap-4">
        {mountTopIframes && (
          <>
            <TopCard src={WIDGETS.lastFollower} title="Ãšltimo Seguidor" messages={FOLLOWER_MESSAGES} badgeVariant="follower" />
            <TopCard src={WIDGETS.lastGifter} title="Ãšltimo Regalo" messages={GIFT_MESSAGES} badgeVariant="gift" />
            <TopCard src={WIDGETS.lastSubscriber} title="Ãšltimo Suscriptor" messages={SUB_MESSAGES} badgeVariant="sub" />
          </>
        )}
      </div>

      {/* Logo centrado (ligeramente mÃ¡s arriba) y widget de alertas grande SIN marco/fondo */}
      <div className="absolute inset-0 flex items-center justify-center mt-[4vh]">
        <div className="relative w-[44vw] max-w-[820px] drop-shadow-[0_0_28px_rgba(0,255,255,0.28)] animate-logoPulse">
          <img src={ASSETS.logo} alt="Canal" className="relative w-full h-auto select-none pointer-events-none" draggable={false} decoding="async" fetchpriority="high" />
          {mountMainIframe && (
            <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
              <iframe src={WIDGETS.actions} title="Notificaciones" className="w-[96%] h-[80%]" frameBorder={0} allow="autoplay" loading="lazy" />
            </div>
          )}
        </div>
      </div>

      {/* Carrusel de redes (verde/azul) */}
      <div className="absolute bottom-5 left-1/2 -translate-x-1/2 w-[92vw] max-w-[1600px] z-40">
        <SocialCarousel />
      </div>

      {/* Estilos globales */}
      <style>{`
        @keyframes logoPulse { 0%, 100% { transform: scale(1) translateY(0); } 25% { transform: scale(1.05) translateY(-6px); } 50% { transform: scale(1.08) translateY(0); } 75% { transform: scale(1.05) translateY(6px); } }
        .animate-logoPulse { animation: logoPulse 7s ease-in-out infinite; }
        .font-roboto { font-family: 'Roboto', system-ui, -apple-system, Segoe UI, Arial, sans-serif; }
        @keyframes glowPulse { 0%,100% { opacity:.45 } 50% { opacity:.9 } }
      `}</style>
    </div>
  );
}
